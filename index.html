<!DOCTYPE html>
<!-- This is a very simple example of using Web WorldWind. -->
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>ISS Tracker</title>
        <!-- Include the Web WorldWind library. -->
        <script src="https://files.worldwind.arc.nasa.gov/artifactory/web/0.9.0/worldwind.min.js"
                type="text/javascript">
        </script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="satellite.min.js"></script>
        <style>
            body {
                margin: 0;
                padding: 0;
                overflow: hidden;
            }
            #canvas {
                width: 100vw;
                height: 100vh;
                background-color: black;
            }
        </style>
    </head>
    <body>
        <div style="position: absolute;">
            <!-- Create a canvas for Web WorldWind. -->
            <canvas id="canvas">
                Your browser does not support HTML5 Canvas.
            </canvas>
        </div>
        <script>
            const issRouteSec = 6000;
            window.addEventListener("load", eventWindowLoaded, false);
            window.addEventListener("dblclick", focusISS);

            function focusISS() {
                wwd.goTo(new WorldWind.Location(positions[issRouteSec/2]['latitude'], positions[issRouteSec/2]['longitude']));
            }

            function get_iss_pos(satrec, time) {
                //  Propagate satellite using JavaScript Date
                var positionAndVelocity = satellite.propagate(satrec, time);

                // The position_velocity result is a key-value pair of ECI coordinates.
                // These are the base results from which all other coordinates are derived.
                var positionEci = positionAndVelocity.position,
                    velocityEci = positionAndVelocity.velocity;

                // You will need GMST for some of the coordinate transforms.
                // http://en.wikipedia.org/wiki/Sidereal_time#Definition
                var gmst = satellite.gstime(time);
                var positionGd    = satellite.eciToGeodetic(positionEci, gmst);
                // Geodetic coords are accessed via `longitude`, `latitude`, `height`.
                var longitude = positionGd.longitude,
                    latitude  = positionGd.latitude,
                    height    = positionGd.height;

                var a = 57.2957795;
                return [longitude * a, latitude * a, height];
            }

            // Create a WorldWindow for the canvas.
            var wwd = new WorldWind.WorldWindow("canvas");
            var modelLayer = new WorldWind.RenderableLayer();

            // Define the event listener to initialize Web WorldWind.
            function eventWindowLoaded() {
                var starFieldLayer = new WorldWind.StarFieldLayer();
                var atmosphereLayer = new WorldWind.AtmosphereLayer();
                var now = new Date();
                starFieldLayer.time = now;
                atmosphereLayer.time = now;
                var layers = [
                    // Imagery layers.
                    {layer: new WorldWind.BMNGLayer(), enabled: true},
                    {layer: new WorldWind.BMNGLandsatLayer(), enabled: false},
                    {layer: new WorldWind.BingAerialLayer(null), enabled: false},
                    {layer: new WorldWind.BingAerialWithLabelsLayer(null), enabled: false},
                    {layer: new WorldWind.BingRoadsLayer(null), enabled: false},
                    {layer: starFieldLayer, enabled: true},
                    // Add atmosphere layer on top of all base layers.
                    {layer: atmosphereLayer, enabled: true},
                    // WorldWindow UI layers.
                    {layer: new WorldWind.CompassLayer(), enabled: true},
                    {layer: new WorldWind.CoordinatesDisplayLayer(wwd), enabled: true},
                    {layer: new WorldWind.ViewControlsLayer(wwd), enabled: true}
                ];

                for (let i = 0; i < layers.length; i++) {
                    layers[i].layer.enabled = layers[i].enabled;
                    wwd.addLayer(layers[i].layer);
                }

                wwd.addLayer(modelLayer);
            }

            
            // ISS 3D model
            var config = {dirPath: '/3D-model/'};
            // var config = {dirPath: '/Nasa_Space_App/3D-model/'};
            var colladaLoader = new WorldWind.ColladaLoader(positions ? positions[issRouteSec/2] : [0, 0, 0], config);
            colladaLoader.load("textured.dae", function (colladaModel) {
                colladaModel.scale = 140000;
                modelLayer.addRenderable(colladaModel);
            });

            var positions = [];
            var issRouteAttributes = new WorldWind.ShapeAttributes();
            issRouteAttributes.outlineColor = new WorldWind.Color(0, 1, 0, 1);
            issRouteAttributes.interiorColor = new WorldWind.Color(0, 0, 1, 0);
            // fetch ISS data
            axios.get("https://live.ariss.org/iss.txt")
                .then((res) => {
                //console.log(res.data);
                lines = res.data.split(/\r?\n/);
                
                var tleLine1 = lines[1],
                    tleLine2 = lines[2];    

                var satrec = satellite.twoline2satrec(tleLine1, tleLine2);
                var t = new Date();
                t.setSeconds(t.getSeconds() - issRouteSec/2);
                for(var i=0;i<issRouteSec;i++){
                    t.setSeconds(t.getSeconds() + 1);
                    var pos = get_iss_pos(satrec, t);
                    positions.push(new WorldWind.Position(pos[1], pos[0], pos[2] * 1000));
                }
                
                // calculate ISS position every second
                function draw_ISS() {
                    position = positions[issRouteSec/2];
                    colladaLoader.position['latitude'] = position['latitude'];
                    colladaLoader.position['longitude'] = position['longitude'];
                    colladaLoader.position['altitude'] = position['altitude'];
                    positions.shift();
                    var t = new Date();
                    t.setSeconds(t.getSeconds() + issRouteSec/2);
                    var pos = get_iss_pos(satrec, t);
                    positions.push(new WorldWind.Position(pos[1], pos[0], pos[2] * 1000));
                    modelLayer.refresh();
                    wwd.redraw();
                };

                draw_ISS();
                setInterval(draw_ISS, 1000);

                var issRoute = new WorldWind.Path(positions, issRouteAttributes);
                issRoute.extrude = true;
                modelLayer.addRenderable(issRoute);
                var prevIssRoute = issRoute;

                function draw_route() {
                    modelLayer.removeRenderable(prevIssRoute);
                    var issRoute = new WorldWind.Path(positions, issRouteAttributes);
                    issRoute.extrude = true;
                    modelLayer.addRenderable(issRoute);
                    prevIssRoute = issRoute;
                    modelLayer.refresh();
                    wwd.redraw();
                }
                
                draw_route();
                setInterval(draw_route, 5000);
            }).then(() => {focusISS();});
        </script>
    </body>
</html>




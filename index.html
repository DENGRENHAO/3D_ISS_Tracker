<!DOCTYPE html>
<!-- This is a very simple example of using Web WorldWind. -->
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>ISS Tracker</title>
        <!-- Include the Web WorldWind library. -->
        <script src="https://files.worldwind.arc.nasa.gov/artifactory/web/0.9.0/worldwind.min.js"
                type="text/javascript">
        </script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="satellite.min.js"></script>
        <style>
            body {
                margin: 0;
                padding: 0;
                background-color: black;
                color: white;
                /*overflow: hidden;*/
            }
            #canvas {
                width: 100vw;
                height: 100vh;
                background-color: black;
            }
            #time-input {
                width: 80vw;
            }
            #timeline {
                margin: 0 auto;
                width: fit-content;
            }
        </style>
    </head>
    <body>
        <div style="position: absolute;">
            <!-- Create a canvas for Web WorldWind. -->
            <canvas id="canvas">
                Your browser does not support HTML5 Canvas.
            </canvas>
            <div id="timeline">
                <input type="range" id="time-input" min="-1440" max="1440" oninput="update_time();">
                <div id="time">0</div>
            </div>
        </div>
        <script>
            let roundDecimal = function (val, precision) {
				return Math.round(Math.round(val * Math.pow(10, (precision || 0) + 1)) / 10) / Math.pow(10, (precision || 0));
			}
            const issRouteSec = 6000;
            window.addEventListener("load", eventWindowLoaded, false);
            window.addEventListener("dblclick", focusISS);

            function toDateTime(secs) {
                var t = new Date(1970, 0, 1); // Epoch
                t.setSeconds(secs);
                return t;
            }

            function getCurentTime() {
                return Math.round(Date.now() / 1000)
            }

            function focusISS() {
                wwd.goTo(new WorldWind.Location(cur_iss_position[0], cur_iss_position[1]));
            }

            function get_iss_pos(satrec, time) {
                time = toDateTime(time);
                //  Propagate satellite using JavaScript Date
                var positionAndVelocity = satellite.propagate(satrec, time);

                // The position_velocity result is a key-value pair of ECI coordinates.
                // These are the base results from which all other coordinates are derived.
                var positionEci = positionAndVelocity.position,
                    velocityEci = positionAndVelocity.velocity;

                // You will need GMST for some of the coordinate transforms.
                // http://en.wikipedia.org/wiki/Sidereal_time#Definition
                var gmst = satellite.gstime(time);
                var positionGd    = satellite.eciToGeodetic(positionEci, gmst);
                // Geodetic coords are accessed via `longitude`, `latitude`, `height`.
                var longitude = positionGd.longitude,
                    latitude  = positionGd.latitude,
                    height    = positionGd.height;

                var a = 57.2957795;
                return [latitude * a, longitude * a, height, velocityEci];
            }

            // Create a WorldWindow for the canvas.
            var wwd = new WorldWind.WorldWindow("canvas");
            var modelLayer = new WorldWind.RenderableLayer();

            // Define the event listener to initialize Web WorldWind.
            var text;
            function eventWindowLoaded() {
                var starFieldLayer = new WorldWind.StarFieldLayer();
                var atmosphereLayer = new WorldWind.AtmosphereLayer();
                var now = new Date();
                starFieldLayer.time = now;
                atmosphereLayer.time = now;
                // info
                var offset;
                var textLayer = new WorldWind.RenderableLayer("information");
                offset = new WorldWind.Offset(WorldWind.OFFSET_FRACTION, 0.2, WorldWind.OFFSET_FRACTION, 0);
                text = new WorldWind.ScreenText(offset, "Loading...");
                text.attributes.offset = new WorldWind.Offset(WorldWind.OFFSET_FRACTION, 0.5, WorldWind.OFFSET_FRACTION, 0.1);
                textLayer.addRenderable(text);
                
                var layers = [
                    // Imagery layers.
                    {layer: new WorldWind.BMNGLayer(), enabled: true},
                    {layer: new WorldWind.BMNGLandsatLayer(), enabled: false},
                    {layer: new WorldWind.BingAerialLayer(null), enabled: false},
                    {layer: new WorldWind.BingAerialWithLabelsLayer(null), enabled: false},
                    {layer: new WorldWind.BingRoadsLayer(null), enabled: false},
                    {layer: new WorldWind.OpenStreetMapImageLayer(null), enabled: false},
                    {layer: starFieldLayer, enabled: true},
                    // Add atmosphere layer on top of all base layers.
                    {layer: atmosphereLayer, enabled: true},
                    // WorldWindow UI layers.
                    {layer: textLayer, enabled: true},
                    {layer: new WorldWind.CompassLayer(), enabled: true},
                    {layer: new WorldWind.CoordinatesDisplayLayer(wwd), enabled: true},
                    {layer: new WorldWind.ViewControlsLayer(wwd), enabled: true}
                ];

                for (let i = 0; i < layers.length; i++) {
                    layers[i].layer.enabled = layers[i].enabled;
                    wwd.addLayer(layers[i].layer);
                }

                wwd.addLayer(modelLayer);
            }

            
            // ISS 3D model
            //var config = {dirPath: '/3D-model/'};
            var config = {dirPath: '/Nasa_Space_App/3D-model/'};
            var cur_iss_position = [0, 0, 0];
            var colladaLoader = new WorldWind.ColladaLoader(
                new WorldWind.Position(cur_iss_position[0], cur_iss_position[1], cur_iss_position[2] * 1000),
                config
                );
            
            colladaLoader.load("textured.dae", function (colladaModel) {
                colladaModel.scale = 140000;
                modelLayer.addRenderable(colladaModel);
            });

            function get_route(time) {
                var positions = new Array(issRouteSec);
                var t = time - issRouteSec/2;
                for (var i = 0; i < issRouteSec; i++) {
                    var pos = get_iss_pos(satrec, t + i);
                    positions[i] = new WorldWind.Position(pos[0], pos[1], pos[2] * 1000);
                }

                return positions;
            }

            var issRouteAttributes = new WorldWind.ShapeAttributes();
            issRouteAttributes.outlineColor = new WorldWind.Color(0, 1, 0, 1);
            issRouteAttributes.interiorColor = new WorldWind.Color(0, 0, 1, 0);
            var prevIssRoute;

            function draw_route(time) {
                if (prevIssRoute) {
                    modelLayer.removeRenderable(prevIssRoute);
                }
                
                var issRoute = new WorldWind.Path(get_route(time), issRouteAttributes);
                issRoute.extrude = true;
                modelLayer.addRenderable(issRoute);
                modelLayer.refresh();
                wwd.redraw();

                prevIssRoute = issRoute;
            }

            // calculate ISS position every second
            function draw_ISS(time) {
                var pos = get_iss_pos(satrec, time)
                cur_iss_position = pos;
                colladaLoader.position['latitude'] = pos[0];
                colladaLoader.position['longitude'] = pos[1];
                colladaLoader.position['altitude'] = pos[2];
                modelLayer.refresh();
                wwd.redraw();
            };

            var satrec;
            // fetch ISS data
            axios.get("https://live.ariss.org/iss.txt")
                .then((res) => {
                //console.log(res.data);
                lines = res.data.split(/\r?\n/);
                
                var tleLine1 = lines[1],
                    tleLine2 = lines[2];    

                satrec = satellite.twoline2satrec(tleLine1, tleLine2);
                }).then(() => {
                    function updateISS() {
                        draw_ISS(getCurentTime());
                        // info
                        var pos = get_iss_pos(satrec, getCurentTime());
                        var velocity = Math.sqrt(pos[3]['x'] * pos[3]['x'] + pos[3]['y'] * pos[3]['y'] + pos[3]['z'] * pos[3]['z']);
                        var lo = roundDecimal(pos[1], 4);
                        var la = roundDecimal(pos[0], 4);
                        var info = `
                            Longtitude: ${Math.abs(lo)}${lo > 0 ? "째E" : "째W"}
                            Latitude: ${Math.abs(la)}${la > 0 ? "째N" : "째S"}
                            Altitude: ${roundDecimal(pos[2] / 1000, 4)}km
                            Velocity: ${roundDecimal(velocity, 4)}km
                            `
                        text.text = info;
                        // redraw
                        modelLayer.refresh();
                        wwd.redraw();
                    }
                    updateISS();
                    setInterval(updateISS, 1000);

                    function updateRoute() {
                        draw_route(getCurentTime());
                    }
                    updateRoute();
                    setInterval(updateRoute, 1000);
                    focusISS();
                });
        </script>
    </body>
</html>



